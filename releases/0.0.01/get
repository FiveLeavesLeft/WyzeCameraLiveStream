#!/bin/sh -x

# These are useful for debug. You shouldn't have to change anything.

# Uncomment this if you want to browse the output of iCamera
# Useful for debugging.
# WYZE_APP_LOGFILE=/tmp/xx

# Uncomment this is you want to borwse the output of the stream hack
# Useful for debugging.
# STREAM_HACK_LOGFILE=/tmp/stream_hack.log

# Uncomment this is if you want to set the port the hack listens on
# STREAM_HACK_PORT=12345

# Uncomment this is if you want change the limp
# STREAM_HACK_LIB='www.sonic.net/~crb/libimp.so'

# Experimental: stream_hack over p2p
# STREAM_HACK_P2P='165.232.153.160:5005'

# DO NOT EDIT BELOW THIS LINE.

TMP_FILE=/tmp/stream_hack.tmp

if [ -z "WYZE_APP_LOGFILE" ]; then
	WYZE_APP_LOGFILE='/dev/null'
fi

if [ -z "STREAM_HACK_LIBIMP" ]; then
	STREAM_HACK_LIB='www.sonic.net/~crb/libimp.so'
fi

cd /configs

rm -rf stream_hack
mkdir stream_hack
cd stream_hack
wget $STREAM_HACK_LIB
mv $STREAM_HACK_LIB libimp.so
if [ ! -z "STREAM_HACK_LOGFILE" ]; then
	ln -s $STREAM_HACK_LOGFILE log
fi
if [ ! -z "STREAM_HACK_P2P" ]; then
	echo $STREAM_HACK_P2P > p2p
fi
if [ ! -z "STREAM_HACK_PORT" ]; then
	echo $STREAM_HACK_PORT > port
fi

echo > $TMP_FILE << EOF
#!/bin/sh
export LD_LIBRARY_PATH='/configs/stream_hack:$LD_LIBRARY_PATH'
/configs/wyze_hack.sh.orig >& $WYZEAPP_LOGFILE &
EOF

if [ -w wyze_hack.sh ]; then
        if ! grep stream_hack wzye_hack.sh ; then
		cp wzye_hack.sh wyze_hack.sh.orig
		mv $TMP_FILE wyze_hack.sh
		chmod +x wyze_hack.sh wyze_hack.sh.orig
        fi
fi

rm -f $TMP_FILE

system_read_only=$(grep -w /system /proc/mounts | grep -w -c ro)
if [ $system_read_only != 0 ]; then
        #echo "system read only"
        exit
fi

echo > $TMP_FILE << EOF
#!/bin/sh
export LD_LIBRARY_PATH='/configs/stream_hack:$LD_LIBRARY_PATH'
/system/init/app_init.sh.orig >& $WYZEAPP_LOGFILE &
EOF

cd /system/init
if [ -w app_init.sh ]; then
        if ! grep stream_hack app_init.sh ; then
		cp app_init.sh app_init.sh.orig
		mv $TMP_FILE app_init.sh
		chmod +x app_init.sh app_init.sh.orig
        fi
fi
rm -f $TMP_FILE

